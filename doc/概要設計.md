# Galuchat API 活用・GPSログ要約サーバー 概要設計書

---

## 1. 目的

* GPSログを「座標 → 地区名」に変換し、時刻付き位置サンプルから **滞在時間を抽出**する MCP サーバーを設計する。
* **PHP側は座標変換と滞在抽出のみ**を担当し、要約・旅行記化は LLM 側に委譲する。
* 将来的に地区メタデータや地図生成を追加できるよう、後方互換なI/Fを整備する。

---

## 2. 全体方針

* **LLM**：入力整形（CSV/GPX/自然文→JSON）と、出力整形（サマリ文・票・旅行記）を担当。
* **MCPサーバー（PHP）**：Galuchat API を利用した逆ジオコーディングと、位置サンプルからの滞在抽出を行う。
* **スキーマ厳格化**：余計な推測や曖昧処理は行わず、モードや要約はLLMに任せる。

---

## 3. MCPツール設計

### 3.1 `resolve_points`（コア機能）

* **入力**

  ```json
  {
    "granularity": "admin|estat|jarl",
      "points": [
        { "ref?": "string (≤128 chars)", "lat": number, "lon": number }
      ]
  }
  ```

  * `granularity`: 粒度（行政区/統計区/JCC-JCG）。省略時は `admin`。
  * `points`: 座標配列。最大 10,000 点程度。
    * `ref`: LLM が独自に付与する参照タグ。**最大128文字**。英数字・ハイフン・アンダースコア・ピリオド・コロンの利用を推奨。

* **出力**

  ```json
  {
    "granularity": "admin|estat|jarl",
    "results": [
      {
        "ref?": "string",
        "success": true,
        "payload": { "code": "string", "address": "string" }
      },
      {
        "ref?": "string",
        "success": false,
        "error": {
          "code": "INVALID_COORD|API_ERROR|RATE_LIMIT|OUT_OF_COVERAGE|INVALID_REF",
          "message": "string"
        }
      }
    ]
  }
  ```

  * **入力順＝出力順**を保持し、各要素に `success` フラグと `payload` または `error` を含める。
  * `ref` が渡されていれば各要素で **そのまま返す**（LLM 側で時刻や元行と JOIN 可能）。
  * `lat` と `lon` は出力に含めず、`ref` または配列順で入力と照合する。

### 3.2 `summarize_stays`

* **概要**

  * 時刻付きの位置サンプル列から滞在を検出し、滞在期間と中心座標を返す。

* **入力**

  ```json
  {
    "positions": [
      { "timestamp": number, "lat": number, "lon": number }
    ],
    "params?": { "distance_threshold_m?": number, "duration_threshold_sec?": number }
  }
  ```

  * `positions`: 時系列順の位置サンプル。
  * `params`: 閾値。距離はメートル、時間は秒。省略時は 50m / 120sec。

* **出力**

  ```json
  {
    "results": [
      { "start_ts": number, "end_ts": number, "center": {"lat": number, "lon": number}, "duration_sec": number }
    ]
  }
  ```

  * `results`: 検出した滞在。`center` は滞在サンプルの平均位置。無効な位置サンプルは結果に含めず黙って無視される。

---

## 4. 緯度経度入力仕様

* **型**: JSON number
* **表記**: 小数点形式のみ。指数表記や文字列不可。整数のみも不可。必ず小数点を含む。
  例: `35.6812`, `139.7671`
* **範囲**:

  * 緯度（lat）: 20.0 ≤ lat ≤ 50.0
  * 経度（lon）: 120.0 ≤ lon ≤ 155.0
* **精度**: 小数点以下最大6桁。
* **丸め**: 受信時に6桁に丸める。出力には含めない。
* **JSON Schema例**:

  ```json
  "lat": {"type": "number", "minimum": 20.0, "maximum": 50.0, "multipleOf": 0.000001},
  "lon": {"type": "number", "minimum": 120.0, "maximum": 155.0, "multipleOf": 0.000001}
  ```

---

## 5. エンドポイント

* `GET  /mcp/manifest`

  * MCPクライアント用のマニフェスト（`resolve_points` の説明・スキーマ・最小例）。
* `POST /tools/resolve_points`

  * 座標変換API。Galuchat API を呼び出し、結果を整形して返却。

---

## 6. エラー仕様

* `INVALID_ARGUMENT` : スキーマ不正、座標レンジ外、点数上限超過
* `OUT_OF_RANGE` : 単点の範囲外
* `RATE_LIMIT` : レート制御
* `INTERNAL` : 内部エラー

**形式**:

```json
{ "error": { "code": "INVALID_ARGUMENT", "message": "Bad input." } }
```

---

## 7. 実装要件（PHP側）

1. **入力検証**：JSON Schema 準拠検証、座標レンジ・配列長チェック。
2. **Galuchat API クライアント**：粒度ごとに逆ジオ呼び出し。
3. **結果整形**：入力順を保持し、`ref` をエコーバック、各要素に `success` と `payload` または `error` を付けた `results` を返す。
4. **エラーハンドリング**：定型エラーを返す。
5. **レート制限**：シンプルに QPS/日次制御。
6. **ログ**：座標は保存せず、統計的カウンタのみ。

---

## 8. 将来拡張

* **`meta` フィールド追加**：地区ごとの人口・用途地域などを返す。
* **地図画像生成API**：`render_overview_map` を追加し、PNG/JPEG を返す。
* **非同期モード**：大規模ログ向けに `trace_id` で後からまとめ取得。

---

## 9. まとめ

* MCPサーバーは「座標→地区情報」変換のみを厳格に提供。
* LLMは入力整形・要約・旅行記生成を担当し、`ref` を使って元データと再結合。
* 緯度経度は小数点表記限定、範囲・精度を厳格化。
* この設計で最小の実装コストと将来拡張性を両立できる。
