# Galuchat API 活用・GPSログ要約サーバー 概要設計書

---

## 1. 目的

* GPSログを「座標 → 地区名」に変換し、時刻付き位置サンプルから **滞在時間を抽出**する MCP サーバーを設計する。
* **PHP側は座標変換と滞在抽出のみ**を担当し、要約・旅行記化は LLM 側に委譲する。
* 将来的に地区メタデータや地図生成を追加できるよう、後方互換なI/Fを整備する。

---

## 2. 全体方針

* **LLM**：入力整形（CSV/GPX/自然文→JSON）と、出力整形（サマリ文・票・旅行記）を担当。
* **MCPサーバー（PHP）**：Galuchat API を利用した逆ジオコーディングと、位置サンプルからの滞在抽出を行う。
* **スキーマ厳格化**：余計な推測や曖昧処理は行わず、モードや要約はLLMに任せる。

---

## 3. MCPツール設計

### 3.1 `resolve_points`（コア機能）

* **入力**

  ```json
  {
    "granularity": "admin|estat|jarl",
      "points": [
        { "ref?": "string|null (≤128 chars, may be empty)", "lat": number, "lon": number }
      ]
  }
  ```

  * `granularity`: 粒度（行政区/統計区/JCC-JCG）。省略時は `admin`。
  * `points`: 座標配列。最大 10,000 点程度。
    * `ref`: LLM が独自に付与する参照タグ。**最大128文字**。空文字や `null` を許容し、英数字・ハイフン・アンダースコア・ピリオド・コロンの利用を推奨。

* **出力**

  ```json
  {
    "granularity": "admin|estat|jarl",
    "results": [
      { "ref?": "string|null", "code": "string|null", "address": "string|null" }
    ]
  }
  ```

  * `results` は **全点が成功した場合のみ**返却する。いずれかでエラーが発生した場合は `results` を返さず、`{"error": {"code", "message", "location?"}}` 形式の単一エラー応答を返す。
  * `ref` が渡されていれば各要素で **そのまま返す**（LLM 側で時刻や元行と JOIN 可能）。渡されていなければ `ref` フィールドは含まれない。
  * Galuchat API が地点を `null` で返した場合は、その地点の `code` と `address` を `null` とした要素を `results` に含める。
  * `lat` と `lon` は出力に含めず、`ref` または配列順で入力と照合する。

  ```jsonc
  {
    "granularity": "admin",
    "results": [
      { "ref": "p1", "code": "13101", "address": "東京都千代田区" },
      { "code": null, "address": null }
    ]
  }
  ```

### 3.2 `summarize_stays`

* **概要**

  * 時刻付きの位置サンプル列を Galuchat API で地区コードに変換し、
    連続して同じコードに属するサンプルをまとめて滞在期間を抽出する。

* **入力**

  ```json
  {
    "positions": [
      { "timestamp": number, "lat": number, "lon": number }
    ]
  }
  ```

  * `positions`: 時系列順の位置サンプル（最大 10,000 サンプル程度）。
  * 無効な位置サンプルが含まれている場合は `INVALID_INPUT` エラーを返し、処理を中断する。
  * 地区コードを取得できなかったサンプルは `code` と `address` を `null` として処理を続行する。

    > **補足**: 「無効な位置サンプル」とは JSON フォーマットの欠落や数値型でない緯度経度など、
    > 仕様から外れた入力を指す。この場合はリクエスト全体を `INVALID_INPUT` として終了する。
    > 一方、サンプル自体が有効でも Galuchat API が地区コードを返せない場合は、該当サンプルの
    > `code` と `address` を `null` にしたまま他のサンプルの処理を続行する。

* **出力**

  ```json
  {
    "results": [
      {
        "start_ts": number,
        "end_ts": number,
        "code": string|null,
        "address": string|null,
        "duration_sec": number,
        "count": number
      }
    ]
  }
  ```

  * `results`: 検出した滞在。`code` は地区コード、`address` はその住所表記、`count` は滞在に含まれるサンプル数。
  * GaluchatAPI が null を返した場合、対応する `code` と `address` も null として返却する。
  * 入力検証または GaluchatAPI 応答で問題が生じた場合は `results` を返さず、`{error:{code,message,location?}}` の単一エラーを返す。

---

## 4. 緯度経度入力仕様

* **型**: JSON number
* **表記**: 整数または小数点形式を許容。指数表記や文字列不可。
  例: `35.6812`, `139.7671`, `35`, `139`
* **範囲**: 制限なし（全世界の座標を受け付ける）。
* **精度**: `resolve_points` では小数点以下最大6桁。`summarize_stays` では精度制約を設けない。
* **丸め**: `resolve_points` は入力が 0.000001 の倍数であることを要求し、サーバー側で追加の丸めは行わない。
* **JSON Schema例** (`resolve_points`):

  ```json
  "lat": {"type": "number", "multipleOf": 0.000001},
  "lon": {"type": "number", "multipleOf": 0.000001}
  ```

---

## 5. エンドポイント

* `GET  /mcp/manifest`

  * MCPクライアント用のマニフェスト（`resolve_points` の説明・スキーマ・最小例）。
* `POST ../tools/resolve_points`

  * 座標変換API。Galuchat API を呼び出し、結果を整形して返却。
* `POST ../tools/summarize_stays`

  * 連続する位置情報サンプルを滞在単位に集約する API。

---

## 6. エラー仕様

* `INVALID_INPUT` : スキーマ不正などの入力エラー
* `API_ERROR` : GaluchatAPI が処理を行わずに返したエラー
* `OUT_OF_COVERAGE` : GaluchatAPI 応答の不整合や欠落（件数不一致や住所欠落など）
* `RATE_LIMIT` : レート制御
* `INTERNAL` : MCP サーバー内部エラー

Galuchat API が地点を `null` として返した場合は `OUT_OF_COVERAGE` ではなく、該当点を `code`/`address` が `null` の要素として `results` に含める。

**形式**:

```json
{
  "error": {
    "code": "INVALID_INPUT",
    "message": "Bad input.",
    "location?": {"index": 0, "ref": "p1"}
  }
}
```

`location` は問題が発生した要素を示すインデックスや `ref` を含める。

---

## 7. 実装要件（PHP側）

1. **入力検証**：JSON Schema 準拠検証、配列長チェック。
2. **Galuchat API クライアント**：粒度ごとに逆ジオ呼び出し。
3. **結果整形**：入力順を保持し、`ref` をエコーバックして `results` を組み立てる。いずれかの処理でエラーが発生した場合は `results` を返さず単一エラー応答とする。
4. **エラーハンドリング**：コードとメッセージ、必要に応じて `location` を含む定型エラーを返す。
5. **レート制限**：シンプルに QPS/日次制御。
6. **ログ**：座標は保存せず、統計的カウンタのみ。

---

## 8. 将来拡張

* **`meta` フィールド追加**：地区ごとの人口・用途地域などを返す。
* **地図画像生成API**：`render_overview_map` を追加し、PNG/JPEG を返す。
* **非同期モード**：大規模ログ向けに `trace_id` で後からまとめ取得。

---

## 9. まとめ

* MCPサーバーは「座標→地区情報」変換のみを厳格に提供。
* LLMは入力整形・要約・旅行記生成を担当し、`ref` を使って元データと再結合。
* 緯度経度は数値形式で受け付け、`resolve_points` では小数点以下6桁を要求し、`summarize_stays` では精度制約を設けない。範囲制限は設けない。
* この設計で最小の実装コストと将来拡張性を両立できる。
